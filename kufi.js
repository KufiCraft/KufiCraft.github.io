
// Copyright 2023 Abd Sattout. All rights reserved.

const $=document.querySelector.bind(document);class Kufi{isPainting=!1;scrolling={is:!1,startX:0,scrollLeft:0,startY:0,scrollTop:0};svg=$("#kufi");tool="pen";color="black";old="default";rect=10;hidden=[];archs=[];lines=[];constructor(t,e,i=!1){this.name=i?localStorage.getItem("kq_name"):t.replace(/\s\s+/g," ").trim(),this.mono=i?"true"===localStorage.getItem("kq_mono"):e,this.size=i?localStorage.getItem("kq_size"):3200,i&&(this.svg.innerHTML=localStorage.getItem("kq_data")),this.svg.style.setProperty("--size",this.size+"px"),document.title+=` - ${this.name}`,$("#container").style.display="block",$("#create").style.display="none",$("#popup").onclick=t=>{t.stopPropagation(),"popup"===t.target.id&&this.popup(!1)},$("#container").scrollTo({top:2e3-innerHeight/2,left:innerWidth/2-2e3}),this.mono&&this.svg.classList.add("mono"),$("#toolbar").style.display="grid";let s,h,n,r;this.svg.addEventListener("touchstart",t=>{this.hidden=[],"pen"==this.tool&&this.backup(),this.paint(!0)},{passive:!0}),this.svg.addEventListener("mousedown",t=>{if(t.preventDefault(),window.installer&&(window.installer.prompt(),window.installer=0),this.hidden=[],!this.isPainting){if(h=(s=document.elementFromPoint(t.clientX,t.clientY)).getBoundingClientRect(),n=(t.clientX-h.left)*1e3/this.svg.clientWidth,r=(t.clientY-h.top)*1e3/this.svg.clientHeight,"kufi"==s.id&&"pen"==this.tool&&(this.backup(),this.drawRect(n,r)),s.parentElement?.id=="kufi"&&"pen"==this.tool&&(this.backup(),this.changeColor(s)),s.parentElement?.id=="kufi"&&"eraser"==this.tool&&this.hide(s),"line"==this.tool){if("rect"==s.tagName.toLowerCase())this.lines.push({x:+s.getAttribute("x"),y:+s.getAttribute("y")}),s.style.fill="tomato",2===this.lines.length&&(this.resets(!1),this.backup(),this.line());else if("kufi"==s.id){h=this.svg.getBoundingClientRect(),n=(t.clientX-h.left)*1e3/this.svg.clientWidth,r=(t.clientY-h.top)*1e3/this.svg.clientHeight;let e=this.getCoor(n,r);(e.height==this.rect||e.height==this.rect/4*3)&&(e.width==this.rect||e.width==this.rect/4*3)&&(this.drawRect(n,r).setAttribute("style","fill:tomato"),this.lines.push({x:e.x,y:e.y}),2===this.lines.length&&(this.resets(!1),this.backup(),this.line()))}else this.info("عذرًا، لا يمكن ربط العقدة بقوس أو عقدة أخرى")}this.tool.includes("arch")&&("rect"==s.tagName.toLowerCase()&&(s.getAttribute("width")==this.rect||s.getAttribute("width")==this.rect/4*3)?(this.backup(),this.archs.length<1?(this.archs.push(s),s.setAttribute("style","fill:mediumspringgreen"),this.info("اختر مربعًا آخر من الصف نفسه")):s.getAttribute("y")===this.archs[0].getAttribute("y")?(this.archs.push(s),this.archs[0].removeAttribute("style"),this.arch(this.archs[0],this.archs[1],"arch2"===this.tool),this.archs=[]):this.info("رجاءً اختر مربعًا على نفس المحور الأفقي")):this.info("يُحمل القوس على مربعين حصرًا")),"hand"==this.tool&&(this.scrolling.is=!0,this.scrolling.startX=t.pageX-$("#container").offsetLeft,this.scrolling.scrollLeft=$("#container").scrollLeft,this.scrolling.startY=t.pageY-$("#container").offsetTop,this.scrolling.scrollTop=$("#container").scrollTop)}this.paint(!0)}),this.svg.addEventListener("touchmove",t=>{h=(s=document.elementFromPoint(t.touches[0].clientX,t.touches[0].clientY)).getBoundingClientRect(),n=(t.touches[0].clientX-h.x)*1e3/h.width,r=(t.touches[0].clientY-h.y)*1e3/h.height,"kufi"==s.id&&"pen"==this.tool&&this.drawRect(n,r),s.parentElement?.id=="kufi"&&"pen"==this.tool&&this.changeColor(s),s.parentElement?.id=="kufi"&&"eraser"==this.tool&&this.hide(s)},{passive:!0}),this.svg.addEventListener("mousemove",t=>{if(t.preventDefault(),this.scrolling.is){let e=t.pageX-$("#container").offsetLeft,i=e-this.scrolling.startX;$("#container").scrollLeft=this.scrolling.scrollLeft-i;let o=t.pageY-$("#container").offsetTop,l=o-this.scrolling.startY;$("#container").scrollTop=this.scrolling.scrollTop-l}this.isPainting&&(s=document.elementFromPoint(t.clientX,t.clientY))&&(h=s.getBoundingClientRect(),n=(t.clientX-h.x)*1e3/h.width,r=(t.clientY-h.y)*1e3/h.height,"kufi"==s.id&&"pen"==this.tool&&this.drawRect(n,r),s.parentElement?.id=="kufi"&&"pen"==this.tool&&this.changeColor(s),s.parentElement?.id=="kufi"&&"eraser"==this.tool&&this.hide(s))}),this.svg.addEventListener("touchend",t=>{this.paint(!1),"eraser"==this.tool&&this.removeHidden()},{passive:!0}),this.svg.addEventListener("mouseup",t=>{t.preventDefault(),this.paint(!1),"eraser"==this.tool&&this.removeHidden(),this.scrolling.is=!1}),window.addEventListener("keydown",t=>{"s"===t.key&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),this.popup(!0)),"z"===t.key&&(t.metaKey||t.ctrlKey)&&(t.preventDefault(),this.undo()),"h"===t.key&&this.setTool("hand")&&t.preventDefault(),"p"===t.key&&this.setTool("pen")&&t.preventDefault(),"e"===t.key&&this.setTool("eraser")&&t.preventDefault(),"l"===t.key&&this.setTool("line")&&t.preventDefault(),"c"===t.key&&this.setTool("arch")&&t.preventDefault()})}setTool(t){this.tool=t;let e=$("#container");return"hand"===t?(e.classList.add("hand"),this.info("اضغط مرتين على اليد للمحاذاة إلى المنتصف")):(e.classList.remove("hand"),this.resets()),"line"==t&&(this.info("حدد نقطتين مختلفتين للوصل بينهما, لا يُستحسن استخدام هذه الأداة لرسم خطوط عمودية أو أفقية إذ لا يمكن رسم قوس عليها كما أنها تعامل كـ كتلة واحدة عند مسحها. تذكر استخدام الضفائر في تصميمك لجعله أكثر جمالية!"),this.lines=[]),"eraser"==t&&this.info("يمكنك الضغط مع السحب لمسح عدة عناصر"),"pen"==t&&this.info(Math.round(-Math.random())),("arch"==t||"arch2"==t)&&this.info("اضغط على مربعين على نفس المحور الأفقي لرسم قوس بينهما — لا تقم بالضغط على أماكن فارغة"),$('[name="tool"]#'+t).checked=!0,!0}setColor(t){return this.color=t,$("#arch").checked||(this.setTool("pen"),$("#pen").checked=!0),this.info("تم تغيير اللون"),!0}snap(){let t=this.svg.getBBox();t.width?$("#container").scrollTo({top:(t.y+t.height/2)*this.svg.clientHeight/1e3-innerHeight/2,left:(t.x-1e3+t.width/2)*(this.svg.clientWidth/1e3)+innerWidth/2}):$("#container").scrollTo({top:2e3-innerHeight/2,left:innerWidth/2-2e3})}zoom(t=1){let e=[1e3*$("#container").scrollTop/this.svg.clientHeight,1e3*$("#container").scrollLeft/this.svg.clientWidth],i=this.svg.clientWidth+400*t;i<=4e3&&i>=800?(this.size=i,this.svg.style.setProperty("--size",i+"px"),$("#container").scrollTo({top:e[0]*this.svg.clientHeight/1e3,left:e[1]*this.svg.clientWidth/1e3}),this.info(-1)):this.info("عذرًا، يوجد حدود لمعدل التكبير")}info(t=!1){if(-1===t){$("#info").textContent="";return}let e=["يمكنك دائمًا تغيير لون الكتابة من خلال الضغط على زر الألوان في شريط الأدوات","يمكنك تصدير اللوحة على شكل ملف SVG حيث يمكنك استخدامه في أي برنامج تصميم آخر","تذكر استخدام اختصارات الكيبورد مثل: P لاستخدام القلم، E لاستخدام الممحاة، H لاستخدام اليد، L لرسم خط مستقيم، C لرسم قوس، Ctrl+S للحفظ، Ctrl+Z للتراجع — يمكنك معرفة الاختصار بالوقوف قليلاً فوق الأداة المطلوبة","تم تطوير هذا التطبيق من Abd Sattout","يمكنك حفظ اللوحة في التطبيق دون الحاجة لتنزيلها للعودة مرة أخرى واستكمال العمل","نسب الفراغ الافتراضية هي 1:3. يمكنك اختيار الشبكة المنتظمة عند بدء العمل","الخط الكوفي أقدم الخطوط العربية","تذكر أنك تستطيع مسح كل شيء في اللوحة بالضغط مرتين على الممحاة","حافظ على توازن تصميمك، التصميم المتناظر مريح للعين","حاول الالتزام بقواعد الخط الكوفي حتى تكون اللوحة مقروءة","لا تترك فراغات في تصميمك","لا بد من وجود رسالة وراء كل تصميم"];return $("#info").textContent=t?"\uD83D\uDC48 "+t:"\uD83D\uDCA1 "+e[Math.round(Math.random()*(e.length-1))],!0}paint(t){return this.isPainting=t,!0}line(){let t=this.mono?this.rect:this.rect/4*3;this.lines[0].y>this.lines[1].y&&(this.lines.unshift(this.lines[1]),this.lines.pop());let e=document.createElementNS("http://www.w3.org/2000/svg","path");return e.setAttribute("stroke",this.color),e.setAttribute("fill","none"),e.setAttribute("stroke-width",t),e.setAttribute("d",`M ${this.lines[0].x+.5*t},${this.lines[0].y} l 0,${.5*t} L ${this.lines[1].x+.5*t},${this.lines[1].y+.5*t} l 0,${.5*t}`),this.svg.insertBefore(e,this.svg.firstChild),this.resets(),this.info(-1),!0}getCoor(t,e){let i,s,h,n;if(this.mono)i=t-t%this.rect,s=e-e%this.rect,h=n=this.rect;else{let r=this.rect/4,o=this.rect-r;t%this.rect<o?(i=t-t%this.rect,h=o):(i=t-t%this.rect+o,h=r),e%this.rect<o?(s=e-e%this.rect,n=o):(s=e-e%this.rect+o,n=r)}return{x:i,y:s,width:h,height:n}}drawRect(t,e){let i=document.createElementNS("http://www.w3.org/2000/svg","rect"),{x:s,y:h,width:n,height:r}=this.getCoor(t,e);return i.setAttribute("x",s),i.setAttribute("y",h),i.setAttribute("width",n),i.setAttribute("height",r),i.setAttribute("fill",this.color),this.svg.appendChild(i),i}changeColor(t){return t.setAttribute("fill",this.color),!0}hide(t){return t.getAttribute("stroke")?t.setAttribute("style","stroke:lightpink"):t.setAttribute("style","fill:lightpink"),this.hidden.push(t),!0}removeHidden(){return this.hidden.length>0&&this.backup(),this.hidden.forEach(t=>t.remove()),this.info(-1),!0}empty(){return this.svg.textContent="",this.info("تم إعادة ضبط اللوحة"),!0}arch(t,e,i=!1){let s,h,n,r,o=+t.getAttribute("y");if(+t.getAttribute("x")<+e.getAttribute("x")?(s=+t.getAttribute("x"),h=+e.getAttribute("x")):(s=+e.getAttribute("x"),h=+t.getAttribute("x")),this.mono&&s!==h){n=(h-s+this.rect)/2,(r=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",`M ${s},${i?o+this.rect:o} a ${n},${n} 0 1 ${i?"0":"1"} ${2*n},0 h -${this.rect} a ${n-this.rect},${n-this.rect} 0 1 ${i?"1":"0"} -${2*n-2*this.rect},0 z`),r.setAttribute("fill",this.color),this.info(-1);let l=this.svg.querySelector(`[d='${r.getAttribute("d")}']`);l&&(this.info("يوجد بالفعل قوس بين هذه النقاط"),l.remove()),this.svg.appendChild(r)}else if(s!==h){n=(h-s+this.rect/4*3)/2,(r=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",`M ${s},${i?o+this.rect/4*3:o} a ${n},${n} 0 1 ${i?"0":"1"} ${2*n},0 h -${this.rect/4*3} a ${n-this.rect/4*3},${n-this.rect/4*3} 0 1 ${i?"1":"0"} -${2*n-this.rect/4*6},0 z`),r.setAttribute("fill",this.color),this.info(-1);let a=this.svg.querySelector(`[d='${r.getAttribute("d")}']`);a&&(this.info("يوجد بالفعل قوس بين هذه النقاط"),a.remove()),this.svg.appendChild(r)}else this.info("الرجاء اختيار نقطتين مختلفتين");return!0}resets(t=!0){return document.querySelectorAll("svg *[style]").forEach(t=>{"tomato"==t.style.fill?t.remove():t.removeAttribute("style")}),this.archs=[],t&&(this.lines=[]),!0}save(){return localStorage.setItem("kq_name",this.name),localStorage.setItem("kq_mono",this.mono),localStorage.setItem("kq_size",this.size),localStorage.setItem("kq_data",this.svg.innerHTML),this.info("تم الحفظ في ذاكرة التطبيق"),!0}undo(){"default"!==this.old&&(this.svg.innerHTML=this.old),this.info("تذكر أن التراجع مرة واحدة"),this.resets()}backup(){return this.old=this.svg.innerHTML,!0}popup(t){return t?$("#popup").style.display="block":$("#popup").style.display="none",!0}async export(t){switch(t){case"pdf":{let e=window.open(""),i=this.svg.getBBox(),s=[i.x,i.y,i.width,i.height].join(" ");e.document.write(`<html><head><title>${this.name}</title>`),e.document.write("</head><body>"),e.document.write(`<svg xmlns="http://www.w3.org/2000/svg" width="${this.svg.style.width}" height="${this.svg.style.height}" viewBox="${s}">${this.svg.innerHTML}</svg>`),e.document.write("<style>svg{width:360px;height: 360px;}</style>"),e.document.write("</body></html>"),e.document.close(),e.print(),e.onfocus=()=>{setTimeout(()=>{e.close()},500)},this.info("قد لا يعمل التصدير إلى PDF في بعض الأجهزة");break}case"png":{let h=document.createElement("a");if(h.href=await convertSVGtoImg(),h.setAttribute("download",this.name.replace(/\s/g,"-")+".png"),document.createEvent){let n=document.createEvent("MouseEvents");n.initEvent("click",!0,!0),h.dispatchEvent(n)}else h.click();this.info(-1);break}default:{let r=document.createElement("a"),o=this.svg.getBBox();if(r.setAttribute("href","data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${o.width}" height="${o.height}" viewBox="${o.x},${o.y},${o.width},${o.height}">${this.svg.innerHTML}</svg>`)),r.setAttribute("download",this.name.replace(/\s/g,"-")+".svg"),document.createEvent){let l=document.createEvent("MouseEvents");l.initEvent("click",!0,!0),r.dispatchEvent(l)}else r.click();this.info(-1)}}return!0}}let board;const create=(t=!1)=>{let e=$("#name").value,i=$("#mono").checked;board=new Kufi(e,i,t),window.onerror=t=>board.info(t),t&&(board.info("تم استعادة اللوحة من ذاكرة التطبيق"),board.snap())};onload=()=>{$(".loader").remove(),$("#create button[disabled]").removeAttribute("disabled"),localStorage.getItem("kq_name")&&localStorage.getItem("kq_mono")&&localStorage.getItem("kq_data")&&($("#restore").removeAttribute("hidden"),"#restore"===location.hash&&create(!0))};const loadImage=async t=>{let e=document.createElement("img");return e.src=t,new Promise((t,i)=>{e.onload=()=>t(e),e.onerror=i})},convertSVGtoImg=async t=>{let e=board.svg,i=board.svg.getBBox(),s=new XMLSerializer().serializeToString(e),h=`data:image/svg+xml,${encodeURIComponent(s)}`,n=await loadImage(h),r=document.createElement("canvas");r.width=e.clientWidth,r.height=e.clientHeight;let o=r.getContext("2d");o.drawImage(n,0,0,e.clientWidth,e.clientHeight);let l=o.getImageData(i.x*e.clientWidth/1e3,i.y*e.clientHeight/1e3,i.width*e.clientWidth/1e3,i.height*e.clientHeight/1e3);(r=document.createElement("canvas")).width=i.width*e.clientWidth/1e3,r.height=i.height*e.clientHeight/1e3,(o=r.getContext("2d")).putImageData(l,0,0);let a=await r.toDataURL("image/png",1);return a};